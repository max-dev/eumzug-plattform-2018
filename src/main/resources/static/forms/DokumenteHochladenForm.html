<!--
Formular zum User Task "Dokumente hochladen"

TODO: Noch ist alles sehr hemdsärmelig gelöst
Eventuell eher vorgehen wie in https://forum.camunda.org/t/upload-multiple-files-in-embedded-form/1206/21 gezeigt?
Denn das Hauptproblem ist ja, dass man nun nicht mehr eine Prozessvariable vom Typ 
File hat, sondern ein java.io.File innerhalb von documentList.municipalityDocumentUploadedFiles
-->
<form name="camundaForm">
    <div class="alert alert-info">      
        Scannen Sie die für Sie zutreffenden Dokumente und laden Sie sie hoch.
    </div>
   
    <!-- Mittels ng-repeat wird über jeden Eintrag der in der in documentList enthaltenen Liste
    iteriert und Label gebildet bestehend aus dem Namen des hochzuladenden Dokuments
    und allfälligen Einschränkungen, wann dieses Dokument hochzuladen ist
    
    TODO, sobald Deserialisierung sauber läuft für documentListSerialized: Statt separat die Labels und
    die Input-Felder aufzubereiten, diese innerhalb von einem ng-repeat erstellen
    -->
    <div class="col-xs-6" style="padding-left: 0px; ">
        <div ng-repeat="document in documentList.municipalityDocumentUploadedFiles track by document.municipalityDocumentRelationEntity.documentEntity.name" class="form-group col-xs-12" style="padding-left: 0px;">
            <label style="margin-top: 5px; margin-bottom: 20px; padding-left: 0px;">
                {{document.municipalityDocumentRelationEntity.documentEntity.name}} 
                <span ng-show="document.municipalityDocumentRelationEntity.marriageCondition"><i> (falls verheiratet)</i></span>
                <span ng-show="document.municipalityDocumentRelationEntity.strangerCondition"><i> (falls Ausländer)</i></span>
                <span ng-show="document.municipalityDocumentRelationEntity.childrenCondition"><i> (falls Kinder)</i></span>
            </label>
        </div>
    </div>
    
    <!-- Aktuell (wegen Deserialisierungs-Problem) sind 5 hardcodierte Input-Felder
    vom Camunda-Variablen-Type File erstellt. Wie viele davon angezeigt werden, hängt
    von der Variable documentLength ab, welche unten im script-Code gebildet wird. -->
    <div class="col-xs-6">
        <div ng-show="documentLength > 0" class="input-group" id="document1" style="margin-bottom: 25px; display: table">
            <label class="input-group-btn">
                <span class="btn btn-primary">
                    Browse&hellip; <input type="file"
                                          style="display: none;" 
                                          cam-variable-name="document1"
                                          cam-variable-type="File"
                                          cam-max-filesize="10000000">
                </span>
            </label>
            <input type="text"
                   class="form-control"
                   id="documentText1"
                   readonly>
        </div>
        
        <div ng-show="documentLength > 1" class="input-group" id="document2" style="margin-bottom: 25px; display: table">
            <label class="input-group-btn">
                <span class="btn btn-primary">
                    Browse&hellip; <input type="file"
                                          style="display: none;" 
                                          cam-variable-name="document2"
                                          cam-variable-type="File"
                                          cam-max-filesize="10000000">
                </span>
            </label>
            <input type="text"
                   class="form-control"
                   id="documentText2"
                   readonly>
        </div>
        
        <div ng-show="documentLength > 2" class="input-group" id="document3" style="margin-bottom: 25px; display: table">
            <label class="input-group-btn">
                <span class="btn btn-primary">
                    Browse&hellip; <input type="file"
                                          style="display: none;" 
                                          cam-variable-name="document3"
                                          cam-variable-type="File"
                                          cam-max-filesize="10000000">
                </span>
            </label>
            <input type="text"
                   class="form-control"
                   id="documentText3"
                   readonly>
        </div>
        
        <div ng-show="documentLength > 3" class="input-group" id="document4" style="margin-bottom: 25px; display: table">
            <label class="input-group-btn">
                <span class="btn btn-primary">
                    Browse&hellip; <input type="file"
                                          style="display: none;" 
                                          cam-variable-name="document4"
                                          cam-variable-type="File"
                                          cam-max-filesize="10000000">
                </span>
            </label>
            <input type="text"
                   class="form-control"
                   id="documentText4"
                   readonly>
        </div>
        
        <div ng-show="documentLength > 4" class="input-group" id="document5" style="margin-bottom: 25px; display: table">
            <label class="input-group-btn">
                <span class="btn btn-primary">
                    Browse&hellip; <input type="file"
                                          style="display: none;" 
                                          cam-variable-name="document5"
                                          cam-variable-type="File"
                                          cam-max-filesize="10000000">
                </span>
            </label>
            <input type="text"
                   class="form-control"
                   id="documentText5"
                   readonly>
        </div>
    </div>

    <script cam-script type="text/from-script">
        // Die AngularJS-Scope-Variable camForm.variableManager wird einer lokalen
        // Variable zugewiesen, damit diese mehrfach verwendet werden kann in den
        // folgenden Funktionen
        var variableManager = camForm.variableManager;

        // Lädt beim Ereignis, dass das Formular geladen aber noch nicht angezeigt ist,
        // benötigte Prozessvariablen von der Process Engine (Server) in Variablen im
        // variableManager-Objekt (Client)
        camForm.on('form-loaded', function(){
            variableManager.fetchVariable("documentListSerialized");
        });

        // Sobald alle Variablen cleint-seitig zur Verfügung stehen, werden diese
        // dem AngularJS-Scope-Objekt übergeben, damit diese z.B. über ng-bind
        // angezeigt werden können.
        camForm.on('variables-fetched', function(){
            $scope.documentList = variableManager.variableValue("documentListSerialized");
            // Ermitteln, wie viele Listenelemente vorhanden sind und damit indirekt, wie viele Input-Felder angezeigt werden sollen
            $scope.documentLength = $scope.documentList.municipalityDocumentUploadedFiles.length;
        });

        // Aktuell wird unmittelbar vor dem Absenden des Formulars für alle
        // überflüssigen Dokument-Variablen (document1, 2, ...) die Variable gelöscht
        // damit es nicht zu einem NullPointerException kommt und damit keine unnötigen
        // Prozessvariablen existieren
        // Code hauptsächlich von https://forum.camunda.org/t/multiple-file-uploads-in-the-embedded-form/531/6
        // TODO: Dieser Code wird überflüssig, wenn Deserialisierung sauber läuft
        camForm.on('submit', function() {
            var indexOfUploadFileField = 0;
            for (var i = 0; i < camForm.fields.length; i++) {
                
                if (camForm.fields[i].variableName == 'document1') {

                        if (camForm.fields[i].element.context.value == '') {
                                indexOfUploadFileField = i;
                                camForm.fields.splice(indexOfUploadFileField, 1);
                                camForm.variableManager.destroyVariable('document1');
                        }
                }

                if (camForm.fields[i].variableName == 'document2') {

                        if (camForm.fields[i].element.context.value == '') {
                                indexOfUploadFileField = i;
                                camForm.fields.splice(indexOfUploadFileField, 1);
                                camForm.variableManager.destroyVariable('document2');
                        }
                }

                if (camForm.fields[i].variableName == 'document3') {

                        if (camForm.fields[i].element.context.value == '') {
                                indexOfUploadFileField = i;
                                camForm.fields.splice(indexOfUploadFileField, 1);
                                camForm.variableManager.destroyVariable('document3');
                        }
                }

                if (camForm.fields[i].variableName == 'document4') {

                        if (camForm.fields[i].element.context.value == '') {
                                indexOfUploadFileField = i;
                                camForm.fields.splice(indexOfUploadFileField, 1);
                                camForm.variableManager.destroyVariable('document4');
                        }
                }

                if (camForm.fields[i].variableName == 'document5') {

                        if (camForm.fields[i].element.context.value == '') {
                                indexOfUploadFileField = i;
                                camForm.fields.splice(indexOfUploadFileField, 1);
                                camForm.variableManager.destroyVariable('document5');
                        }
                }
            }
            
            // Damit es nicht zu einem Deserialisierungsfehler kommt, muss documentListSerialized
            // aktuell zerstört werden vor dem Übermitteln
            // TODO: ist nicht mehr nötig, wenn Deserialisierung sauber läuft
            //variableManager.destroyVariable('documentListSerialized');
        });

        // Code, damit nach dem Auswählen einer Datei, der Name dieser Datei
        // im Input-Feld angezeigt wird.
        $(function() {
            // Das Ereignis "fileselect" kann an alle File input Felder angehängt werden.
            $(document).on('change', ':file', function() {
                var input = $(this),
                    numFiles = input.get(0).files ? input.get(0).files.length : 1,
                    label = input.val().replace(/\\/g, '/').replace(/.*\//, '');

                input.trigger('fileselect', [numFiles, label]);
            });

            // Hier können wir unser benutzerdefiniertes Ereignis "fileselect" beobachten
            $(document).ready( function() {
                $(':file').on('fileselect', function(event, numFiles, label) {

                    var input = $(this).parents('.input-group').find(':text'),
                        log = numFiles > 1 ? numFiles + ' files selected' : label;

                    if( input.length ) {
                        input.val(log);
                    } else {
                    }

                });
            });
        });
    </script> 
</form>

<!--
Formular zum UserTask "Mitumziehende Personen wählen"
-->
<form name="camundaForm" style="padding-top: 10px;">
    <div class="alert alert-info">      
        Wählen Sie alle Personen aus, die mit Ihnen umziehen. Aus Datenschutzgründen
        werden nur die Vornamen angezeigt.
    </div>
    
    <!-- Mittels ng-repeat wird über jeden Eintrag der in der in relativesList enthaltenen Liste
    iteriert und Label gebildet bestehend aus dem Vornamen der potentiell mitumziehenden Person
    sowie eine Checkbox, welche als Id die localPersonId enthält (da mehrere Personen den gleichen Vornamen)
    haben könnten. Als Value wird das relative-Objekt selbst gespeichert.
    
    Wichtig: In einer produktiven Lösung dürfte man nicht das relative-Objekt selbst verwenden, 
    da dieses z.B. das Geburtsdatum enthält, welches zwar wohl nicht angezeigt wird, aber 
    natürlich client-seitig leicht durch ein Debugging ausgelesen werden könnte. Stattdessen
    müsste man wirklich nur die Liste der Vornamen plus eine anonymisierte Id für die Rückreferenzierung serverseitig ausgeben
    
    "track by" wird benötigt, weil sonst ein $$hashKey-Attribut dem relatives-Objekt angehängt wird, was eine
    Deserialisierung verunmöglicht.
    -->
    <div class="checkbox" ng-repeat="relative in relatives track by relative.localPersonId">
        <label>
            <input type="checkbox" id="{{relative.localPersonId}}" name="movingAlongPerson" value="{{relative}}">
            {{relative.firstName}}
        </label>
    </div>

    <script cam-script type="text/from-script">
        // Die AngularJS-Scope-Variable camForm.variableManager wird einer lokalen
        // Variable zugewiesen, damit diese mehrfach verwendet werden kann in den
        // folgenden Funktionen
        var variableManager = camForm.variableManager;

        // Lädt beim Ereignis, dass das Formular geladen aber noch nicht angezeigt ist,
        // benötigte Prozessvariablen von der Process Engine (Server) in Variablen im
        // variableManager-Objekt (Client)
        camForm.on('form-loaded', function(){
            // Streng genommen geht das aus Datenschutzgründen nicht (Grund siehe erster Kommentar oben)
            variableManager.fetchVariable("relativesList");
        });

        // Sobald alle Variablen client-seitig zur Verfügung stehen, werden diese
        // dem AngularJS-Scope-Objekt übergeben, damit diese z.B. über ng-bind
        // angezeigt werden können.
        camForm.on('variables-fetched', function(){
            // Die eigentliche Liste wird ausgegeben
            $scope.relatives = variableManager.variableValue("relativesList").relatives;
        });

        // Vor dem Submit wird geprüft, welche Personen ausgewählt wurden. Für diese
        // wird die Eigenschaft moveAlong auf true gesetzt
        camForm.on('submit', function(){
            // JQuery-Funktion, um über alle angehakten Einträge zu iterieren
            $("input:checkbox[name=movingAlongPerson]:checked").each(function(){
                // Für jeden ausgewählten Eintrag über jeden relative iterieren...
                for(var i=0;i<$scope.relatives.length;i++){
                    // ... und falls die id des ausgewählten Elements mit der localPersonId übereinstimmt ...
                    if(this.id == $scope.relatives[i].localPersonId){
                        // ... dann die moveAlong-Eigenschaft auf true setzen
                        $scope.relatives[i].moveAlong = true;
                        // ... und die for-Schleife verlassen
                        break;
                    }
                }
            });
        });
    </script> 
</form>
